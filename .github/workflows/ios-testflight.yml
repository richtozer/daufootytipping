name: iOS TestFlight Build and Upload

on:
  workflow_dispatch:
  push:
    branches:
      - testing
    paths:
      - "lib/**"
      - "ios/**"
      - "pubspec.yaml"
      - "pubspec.lock"
      - ".github/workflows/ios-testflight.yml"

permissions:
  contents: write

jobs:
  build_and_upload:
    name: Build iOS IPA and Upload to TestFlight
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.9"
          channel: "stable"
          cache: true

      - name: Show tool versions
        run: |
          flutter --version
          xcodebuild -version

      - name: Get dependencies
        run: flutter pub get

      - name: Read app version from pubspec
        id: app_version
        run: |
          pubspec_version="$(awk '/^version:/{print $2; exit}' pubspec.yaml)"
          if [ -z "$pubspec_version" ]; then
            echo "Failed to read version from pubspec.yaml"
            exit 1
          fi

          build_name="${pubspec_version%%+*}"
          build_number="${pubspec_version##*+}"
          if [ "$build_name" = "$build_number" ]; then
            echo "pubspec version must include build number, e.g. 1.2.3+456"
            exit 1
          fi

          echo "build_name=$build_name" >> "$GITHUB_OUTPUT"
          echo "build_number=$build_number" >> "$GITHUB_OUTPUT"

      - name: Abort if build number already has a successful iOS tag
        run: |
          set -euo pipefail
          git fetch --force --tags origin

          tag_name="ios-testflight-build-${{ steps.app_version.outputs.build_number }}"
          if git rev-parse -q --verify "refs/tags/$tag_name" >/dev/null; then
            echo "Build number ${{ steps.app_version.outputs.build_number }} has already been marked successful ($tag_name)."
            echo "Bump pubspec build number before rerunning."
            exit 1
          fi

      - name: Validate required secrets
        env:
          IOS_BUILD_CERTIFICATE_BASE64: ${{ secrets.IOS_BUILD_CERTIFICATE_BASE64 }}
          IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
          IOS_BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.IOS_BUILD_PROVISION_PROFILE_BASE64 }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_P8: ${{ secrets.APP_STORE_CONNECT_API_KEY_P8 }}
        run: |
          missing=0
          for var in \
            IOS_BUILD_CERTIFICATE_BASE64 \
            IOS_P12_PASSWORD \
            IOS_BUILD_PROVISION_PROFILE_BASE64 \
            APP_STORE_CONNECT_ISSUER_ID \
            APP_STORE_CONNECT_KEY_ID \
            APP_STORE_CONNECT_API_KEY_P8; do
            if [ -z "${!var}" ]; then
              echo "Missing required secret: $var"
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Install signing certificate
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.IOS_BUILD_CERTIFICATE_BASE64 }}
          p12-password: ${{ secrets.IOS_P12_PASSWORD }}

      - name: Install provisioning profile
        id: profile
        env:
          IOS_BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.IOS_BUILD_PROVISION_PROFILE_BASE64 }}
        run: |
          set -euo pipefail
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          profile_path="$RUNNER_TEMP/ci.mobileprovision"
          echo "$IOS_BUILD_PROVISION_PROFILE_BASE64" | base64 --decode > "$profile_path"

          profile_plist="$RUNNER_TEMP/ci.mobileprovision.plist"
          security cms -D -i "$profile_path" > "$profile_plist"

          uuid=$(/usr/libexec/PlistBuddy -c 'Print :UUID' "$profile_plist")
          name=$(/usr/libexec/PlistBuddy -c 'Print :Name' "$profile_plist")
          team_id=$(/usr/libexec/PlistBuddy -c 'Print :TeamIdentifier:0' "$profile_plist")
          app_identifier=$(/usr/libexec/PlistBuddy -c 'Print :Entitlements:application-identifier' "$profile_plist")
          bundle_id="${app_identifier#*.}"

          echo "uuid=$uuid" >> "$GITHUB_OUTPUT"
          echo "name=$name" >> "$GITHUB_OUTPUT"
          echo "team_id=$team_id" >> "$GITHUB_OUTPUT"
          echo "bundle_id=$bundle_id" >> "$GITHUB_OUTPUT"

          cp "$profile_path" "$HOME/Library/MobileDevice/Provisioning Profiles/$uuid.mobileprovision"
          echo "Using provisioning profile:"
          echo "  Name: $name"
          echo "  UUID: $uuid"
          echo "  Team: $team_id"
          echo "  Bundle: $bundle_id"
          echo "  Entitlements:"
          /usr/libexec/PlistBuddy -c 'Print :Entitlements' "$profile_plist"
          ls -la "$HOME/Library/MobileDevice/Provisioning Profiles"

      - name: Show signing identities
        run: security find-identity -v -p codesigning || true

      - name: Prepare iOS build config
        run: |
          flutter build ios \
            --release \
            --config-only \
            --build-name "${{ steps.app_version.outputs.build_name }}" \
            --build-number "${{ steps.app_version.outputs.build_number }}"

      - name: Archive iOS app (unsigned)
        run: |
          set -euo pipefail
          mkdir -p build/ios/archive

          xcodebuild \
            -workspace ios/Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -destination "generic/platform=iOS" \
            -archivePath "build/ios/archive/Runner.xcarchive" \
            archive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            PROVISIONING_PROFILE=""

      - name: Create export options plist
        id: export_options
        run: |
          export_options="$RUNNER_TEMP/ExportOptions.plist"
          cat > "$export_options" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>signingCertificate</key>
            <string>Apple Distribution</string>
            <key>teamID</key>
            <string>${{ steps.profile.outputs.team_id }}</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>${{ steps.profile.outputs.bundle_id }}</key>
              <string>${{ steps.profile.outputs.name }}</string>
            </dict>
            <key>stripSwiftSymbols</key>
            <true/>
          </dict>
          </plist>
          EOF

          echo "path=$export_options" >> "$GITHUB_OUTPUT"
          cat "$export_options"

      - name: Export signed IPA from archive
        run: |
          archive_path="build/ios/archive/Runner.xcarchive"
          if [ ! -d "$archive_path" ]; then
            echo "Archive not found at $archive_path"
            find build/ios -maxdepth 5 -type d | sort || true
            exit 1
          fi

          mkdir -p build/ios/ipa
          xcodebuild -exportArchive \
            -archivePath "$archive_path" \
            -exportPath "build/ios/ipa" \
            -exportOptionsPlist "${{ steps.export_options.outputs.path }}"

      - name: Find generated IPA
        id: ipa
        run: |
          ipa_path="$(find build/ios -type f -name '*.ipa' | head -n 1)"
          if [ -z "$ipa_path" ]; then
            echo "No IPA file found under build/ios after flutter build ipa."
            find build/ios -maxdepth 5 -type f | sort || true
            exit 1
          fi
          echo "path=$ipa_path" >> "$GITHUB_OUTPUT"
          ls -lh "$ipa_path"

      - name: Validate exported IPA entitlements
        run: |
          set -euo pipefail

          ipa_path="${{ steps.ipa.outputs.path }}"
          work_dir="$RUNNER_TEMP/ipa_entitlements_check"
          rm -rf "$work_dir"
          mkdir -p "$work_dir"
          unzip -q "$ipa_path" -d "$work_dir"

          executable="$work_dir/Payload/Runner.app/Runner"
          entitlements_plist="$work_dir/entitlements.plist"
          codesign -d --entitlements :- "$executable" > "$entitlements_plist" 2>/dev/null || true

          echo "Exported app entitlements:"
          cat "$entitlements_plist"

          /usr/libexec/PlistBuddy -c 'Print :com.apple.developer.applesignin:0' "$entitlements_plist" >/dev/null

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-${{ github.ref_name }}-${{ github.run_number }}
          path: ${{ steps.ipa.outputs.path }}
          if-no-files-found: error
          retention-days: 14

      - name: Upload to TestFlight
        env:
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_P8: ${{ secrets.APP_STORE_CONNECT_API_KEY_P8 }}
        run: |
          mkdir -p "$HOME/.appstoreconnect/private_keys"
          key_path="$HOME/.appstoreconnect/private_keys/AuthKey_${APP_STORE_CONNECT_KEY_ID}.p8"
          printf '%s' "$APP_STORE_CONNECT_API_KEY_P8" > "$key_path"
          chmod 600 "$key_path"

          xcrun altool \
            --upload-app \
            --type ios \
            --file "${{ steps.ipa.outputs.path }}" \
            --apiKey "$APP_STORE_CONNECT_KEY_ID" \
            --apiIssuer "$APP_STORE_CONNECT_ISSUER_ID"

      - name: Tag successful iOS TestFlight build
        run: |
          set -euo pipefail
          tag_name="ios-testflight-build-${{ steps.app_version.outputs.build_number }}"
          tag_message="iOS TestFlight success ${{ steps.app_version.outputs.build_name }}+${{ steps.app_version.outputs.build_number }}"

          if git rev-parse -q --verify "refs/tags/$tag_name" >/dev/null; then
            echo "Tag $tag_name already exists; skipping create."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -a "$tag_name" -m "$tag_message"
          git push origin "$tag_name"
