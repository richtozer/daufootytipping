name: iOS TestFlight Build

on:
  workflow_dispatch:
    inputs:
      upload_to_testflight:
        description: "Upload the built IPA to TestFlight"
        required: true
        default: true
        type: boolean
      changelog:
        description: "Optional TestFlight changelog"
        required: false
        default: ""
        type: string

jobs:
  build_ios:
    name: Build iOS IPA
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.35.1"
          channel: "stable"
          cache: true

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"

      - name: Get dependencies
        run: flutter pub get

      - name: Read app version from pubspec
        id: app_version
        run: |
          pubspec_version="$(awk '/^version:/{print $2; exit}' pubspec.yaml)"
          if [ -z "$pubspec_version" ]; then
            echo "Failed to read version from pubspec.yaml"
            exit 1
          fi
          build_name="${pubspec_version%%+*}"
          build_number="${pubspec_version##*+}"
          echo "build_name=$build_name" >> "$GITHUB_OUTPUT"
          echo "build_number=$build_number" >> "$GITHUB_OUTPUT"

      - name: Configure iOS signing assets
        env:
          IOS_BUILD_CERTIFICATE_BASE64: ${{ secrets.IOS_BUILD_CERTIFICATE_BASE64 }}
          IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
          IOS_BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.IOS_BUILD_PROVISION_PROFILE_BASE64 }}
          IOS_KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
        run: |
          decode_base64_secret() {
            value="$1"
            output="$2"
            if printf "%s" "$value" | base64 --decode > "$output" 2>/dev/null; then
              return 0
            fi
            if printf "%s" "$value" | base64 -d > "$output" 2>/dev/null; then
              return 0
            fi
            if printf "%s" "$value" | base64 -D > "$output" 2>/dev/null; then
              return 0
            fi
            return 1
          }

          missing=0
          for var in IOS_BUILD_CERTIFICATE_BASE64 IOS_P12_PASSWORD IOS_BUILD_PROVISION_PROFILE_BASE64 IOS_KEYCHAIN_PASSWORD; do
            if [ -z "${!var}" ]; then
              echo "Missing required secret: $var"
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

          cert_path="$RUNNER_TEMP/build_certificate.p12"
          profile_path="$RUNNER_TEMP/build_profile.mobileprovision"
          keychain_path="$RUNNER_TEMP/app-signing.keychain-db"

          if ! decode_base64_secret "$IOS_BUILD_CERTIFICATE_BASE64" "$cert_path"; then
            echo "Failed to decode IOS_BUILD_CERTIFICATE_BASE64. Ensure it is base64 of a .p12 file."
            exit 1
          fi
          if ! decode_base64_secret "$IOS_BUILD_PROVISION_PROFILE_BASE64" "$profile_path"; then
            echo "Failed to decode IOS_BUILD_PROVISION_PROFILE_BASE64. Ensure it is base64 of a .mobileprovision file."
            exit 1
          fi
          if [ ! -s "$profile_path" ]; then
            echo "Decoded provisioning profile file is empty."
            exit 1
          fi

          security create-keychain -p "$IOS_KEYCHAIN_PASSWORD" "$keychain_path"
          security set-keychain-settings -lut 21600 "$keychain_path"
          security unlock-keychain -p "$IOS_KEYCHAIN_PASSWORD" "$keychain_path"
          security import "$cert_path" -P "$IOS_P12_PASSWORD" -A -t cert -f pkcs12 -k "$keychain_path"
          security list-keychains -d user -s "$keychain_path" login.keychain-db
          security set-key-partition-list -S apple-tool:,apple: -k "$IOS_KEYCHAIN_PASSWORD" "$keychain_path"

          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          profile_plist="$RUNNER_TEMP/build_profile.plist"
          if ! /usr/bin/security cms -D -i "$profile_path" > "$profile_plist" 2>/dev/null; then
            echo "Provisioning profile is not a valid .mobileprovision payload."
            exit 1
          fi
          profile_name=$(/usr/libexec/PlistBuddy -c 'Print Name' "$profile_plist")
          profile_uuid=$(/usr/libexec/PlistBuddy -c 'Print UUID' "$profile_plist")
          echo "PROFILE_NAME=$profile_name" >> "$GITHUB_ENV"
          echo "PROFILE_UUID=$profile_uuid" >> "$GITHUB_ENV"
          cp "$profile_path" "$HOME/Library/MobileDevice/Provisioning Profiles/ci.mobileprovision"

      - name: Verify signing assets
        run: |
          security find-identity -v -p codesigning
          ls -la "$HOME/Library/MobileDevice/Provisioning Profiles"

      - name: Configure manual iOS signing in project
        run: |
          if [ -z "$PROFILE_NAME" ] || [ -z "$PROFILE_UUID" ]; then
            echo "Missing provisioning profile metadata."
            exit 1
          fi

          project_file="ios/Runner.xcodeproj/project.pbxproj"
          sed -i '' 's/"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]" = "iPhone Developer";/"CODE_SIGN_IDENTITY[sdk=iphoneos*]" = "Apple Distribution";/g' "$project_file"
          sed -i '' '/DEVELOPMENT_TEAM = /a\
					CODE_SIGN_STYLE = Manual;\
					PROVISIONING_PROFILE_SPECIFIER = "'"$PROFILE_NAME"'";\
					PROVISIONING_PROFILE = "'"$PROFILE_UUID"'";\
					"CODE_SIGN_IDENTITY[sdk=iphoneos*]" = "Apple Distribution";' "$project_file"

      - name: Build iOS IPA
        run: |
          flutter build ipa \
            --release \
            --export-method app-store \
            --build-name "${{ steps.app_version.outputs.build_name }}" \
            --build-number "${{ steps.app_version.outputs.build_number }}"

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-${{ github.ref_name }}-${{ github.run_number }}
          path: build/ios/ipa/*.ipa
          retention-days: 30

      - name: Install Fastlane
        if: inputs.upload_to_testflight == true
        run: gem install fastlane --no-document

      - name: Upload to TestFlight
        if: inputs.upload_to_testflight == true
        env:
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_P8: ${{ secrets.APP_STORE_CONNECT_API_KEY_P8 }}
          TESTFLIGHT_CHANGELOG: ${{ inputs.changelog }}
        run: |
          missing=0
          for var in APP_STORE_CONNECT_ISSUER_ID APP_STORE_CONNECT_KEY_ID APP_STORE_CONNECT_API_KEY_P8; do
            if [ -z "${!var}" ]; then
              echo "Missing required secret: $var"
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

          key_path="$RUNNER_TEMP/AuthKey_${APP_STORE_CONNECT_KEY_ID}.p8"
          api_key_json="$RUNNER_TEMP/app_store_api_key.json"
          ipa_path="$(ls build/ios/ipa/*.ipa | head -n 1)"

          printf "%s" "$APP_STORE_CONNECT_API_KEY_P8" > "$key_path"
          escaped_key=$(ruby -rjson -e 'print JSON.generate(STDIN.read)' < "$key_path")
          cat > "$api_key_json" <<EOF
          {"key_id":"$APP_STORE_CONNECT_KEY_ID","issuer_id":"$APP_STORE_CONNECT_ISSUER_ID","key":$escaped_key,"in_house":false}
          EOF

          if [ -n "$TESTFLIGHT_CHANGELOG" ]; then
            fastlane pilot upload \
              --api_key_path "$api_key_json" \
              --ipa "$ipa_path" \
              --changelog "$TESTFLIGHT_CHANGELOG" \
              --skip_waiting_for_build_processing true
          else
            fastlane pilot upload \
              --api_key_path "$api_key_json" \
              --ipa "$ipa_path" \
              --skip_waiting_for_build_processing true
          fi
